# Project Context: Prism NGFW

This document summarizes the current state, architectural decisions, and immediate next steps for the Prism NGFW project.

## 1. Project Overview

- **Project Name**: Prism
- **Goal**: Build a containerized reverse-proxy NGFW/WAF in Go with a React dashboard for management.
- **Current Working Directory**: `/Users/kpradhan/Go-Projects/Prism`
- **Version Control**: Git repository initialized.

## 2. Architectural Decisions & Current State

### 2.1 Go Application Structure
- **Modular Design**: Code is organized into standard Go packages:
    - `cmd/prism`: Contains `main.go`, the application entry point.
    - `pkg/api`: Handles API endpoints (e.g., `/api/v1/hello`).
    - `pkg/firewall`: Contains firewall rules logic (`Middleware`).
    - `pkg/proxy`: Contains reverse proxy logic (`NewReverseProxy`, `Factory`).
    - `pkg/storage`: Handles database connection and data access (`NewDB`, `Repository`, `Project`, `Rule`).

### 2.2 Routing Strategy
- **Path-Based Routing**: The application uses a central `http.ServeMux` to route requests based on URL path:
    - `/<project_name>`: Dynamically routed to the Reverse Proxy Module, which looks up the project's upstream URL and rules in the database.
    - `/user/<username>`: Will serve the Admin Dashboard UI (future).
    - `/api/...`: Will serve the Management API.

### 2.3 Frontend Applications
- **Protected App**: `my-test-app` (React SPA on `http://localhost:3000`) is the application *protected by* Prism, not Prism's dashboard.
- **Management Dashboard**: A separate, future React application will interact with Prism's `/api/...` endpoints.

### 2.4 Authentication & Database
- **Authentication**: **Supabase Auth (Local JWT Verification)**.
- **Database**: **Supabase Postgres** (cloud-hosted).
- **Configuration**: `DATABASE_URL` is loaded from a `.env` file in the project root (`/Users/kpradhan/Go-Projects/Prism/.env`).

## 2.5 Current Functionality (Working & Tested)
- **Application Startup**: `go run ./cmd/prism` (from `Prism` directory).
- **Database Connection**: Successfully connects to Supabase Postgres using `DATABASE_URL` from `.env`.
- **Dynamic Routing & Proxying**: Correctly identifies projects by `path_prefix` from the database, rewrites URLs, and proxies traffic to the correct `upstream_url`.
- **Database-Driven Firewall Rules**: Applies `ip_block` and `keyword_block` rules fetched from the database for each project.
- **Static Asset Handling**: Correctly serves static assets for proxied SPAs (e.g., React app's `bundle.js`, `manifest.json`).
- **API Endpoints (Protected by Supabase JWT Auth)**:
    - `GET /api/v1/hello`: Returns a greeting with the authenticated user ID.
    - `POST /api/v1/projects`: Creates a new project for the authenticated user.
    - `GET /api/v1/projects`: Lists all projects for the authenticated user.
    - `GET /api/v1/projects/{id}`: Retrieves a specific project by ID for the authenticated user.
    - `PUT /api/v1/projects/{id}`: Updates a specific project by ID for the authenticated user.
    - `DELETE /api/v1/projects/{id}`: Deletes a specific project by ID for the authenticated user.

## 3. Immediate Next Step

- **Implement CRUD for Rules**: Implement API endpoints for creating, listing, getting, updating, and deleting firewall rules, linked to projects.

## 4. Key Credentials (User's Responsibility)

- **Supabase Project URL**
- **Supabase `anon` key**
- **Supabase `service_role` key**
- **Supabase JWT Secret** (used for local verification, stored in `.env` as `SUPABASE_JWT_SECRET`)
- **Supabase Database Connection String** (Transaction Pooler, stored in `.env` as `DATABASE_URL`)
- **Supabase Database Password**

## 5. Important Notes

- `CLERK_SECRET_KEY` is no longer used.
- `DATABASE_URL` is crucial for application startup.